<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>송이톡 - 친구들과 소통하는 공간</title>
  <link rel="stylesheet" href="9_마라탕공주들_style.css">
  <link rel="stylesheet" href="css/9_마라탕공주들_chat_detail.css">
</head>
<body>

<!-- 네비게이션 -->
<nav>
  <div class="logo">
    <a href="9_마라탕공주들_index.html">
      <img src="images/9_logo.svg" alt="송이톡 로고">
    </a>
  </div>

  <ul class="menu">
    <li><a href="9_마라탕공주들_index.html">홈</a></li>
    <li><a href="9_마라탕공주들_chat_list.html">채팅</a></li>
    <li><a href="9_마라탕공주들_checklist.html">체크리스트</a></li>
    <li><a href="9_마라탕공주들_history.html">보관함</a></li>
    <li><a href="9_마라탕공주들_setting.html">설정</a></li>
  </ul>

  <div class="nav-right-container">
    <!-- 검색창 -->
    <div class="search-container">
      <input type="text" placeholder="검색 (친구, 채팅, 보관함 등)">
      <button>검색</button>
    </div>

    <!-- 프로필 -->
    <div class="nav-right">
      <a href="9_마라탕공주들_login.html" class="profile">
        <img src="images/9_profile.jpg" alt="프로필 사진" class="profile-img" width="30" height="30">
        <span id="userId">사용자Id</span>
      </a>
    </div>
  </div>
</nav>

<!-- 메인 컨테이너 -->
<div class="container">

  <!-- 왼쪽 사이드바 -->
  <div class="sidebar">
    <h3></h3>

    <div class="widget-box">
      <a href="9_마라탕공주들_checklist.html" class="widget-item">📅 일정</a>
      <a href="9_마라탕공주들_history.html" class="widget-item">📸 추억</a>

      <input type="checkbox" id="memo-toggle" hidden>
      <label for="memo-toggle" class="widget-item">📝 메모</label>
      <div class="memo-box">
        <textarea placeholder="메모를 작성하세요..."></textarea>
      </div>
    </div>
  </div>

    <div class="chat-input">
      <label for="file-upload" class="attach-btn">＋</label>
      <input type="file" id="file-upload" hidden>
      <input type="text" placeholder="메시지를 입력하세요...">
      <button class="send-btn">전송</button>
    </div>
  </div>

</div>

<script src="authCheck.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  try {
    console.log("✅ DOMContentLoaded");

    // 1. 로그인 사용자 정보 가져오기
    const meRes = await fetch("/api/me", { credentials: "include" });
    if (!meRes.ok) throw new Error(`HTTP error! status: ${meRes.status}`);
    const meData = await meRes.json();
    if (!meData.success) throw new Error("로그인 정보 없음");
    document.getElementById("userId").textContent = meData.name;

    // 2️. URL에서 roomId 가져오기
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get("roomId");
    if (!roomId) throw new Error("roomId가 URL에 없음");

    const messagesContainer = document.querySelector(".chat-messages");
    messagesContainer.innerHTML = "";

    // 3. 서버에서 메시지 가져오기
    const res = await fetch(`/api/chatrooms/${encodeURIComponent(roomId)}/messages`, { credentials: "include" });
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const data = await res.json();
    if (!data.success) throw new Error("메시지 불러오기 실패");

    // 4️. 메시지 DOM 생성
    data.messages.forEach(msg => {
      const div = document.createElement("div");
      div.className = msg.sender === meData.userId ? "message me" : "message friend";

      div.innerHTML = `
        <img src="${msg.sender === meData.userId ? 'images/9_profile.jpg' : 'images/9_카톡 기본프로필 사진.jpg'}" class="chat-img">
        <div class="chat-content">
          <div class="chat-name">${msg.sender === meData.userId ? "나" : msg.sender}</div>
          <div class="bubble-row">
            <div class="bubble">${msg.content}</div>
            <div class="meta">
              <span class="time">${new Date(msg.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
            </div>
          </div>
        </div>
      `;
      messagesContainer.appendChild(div);
    });

  } catch (err) {
    console.error("❌ 채팅 불러오기 실패:", err);
    const messagesContainer = document.querySelector(".chat-messages");
    messagesContainer.innerHTML = `<div>메시지를 불러올 수 없습니다.</div>`;
  }
});
</script>



</body>
</html>