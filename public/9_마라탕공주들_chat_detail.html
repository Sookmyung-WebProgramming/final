<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì†¡ì´í†¡ - ì¹œêµ¬ë“¤ê³¼ ì†Œí†µí•˜ëŠ” ê³µê°„</title>
  <link rel="stylesheet" href="9_ë§ˆë¼íƒ•ê³µì£¼ë“¤_style.css">
  <link rel="stylesheet" href="css/9_ë§ˆë¼íƒ•ê³µì£¼ë“¤_chat_detail.css">
</head>
<body>

<!-- ë„¤ë¹„ê²Œì´ì…˜ -->
<nav>
  <div class="logo">
    <a href="9_ë§ˆë¼íƒ•ê³µì£¼ë“¤_index.html">
      <img src="images/9_logo.svg" alt="ì†¡ì´í†¡ ë¡œê³ ">
    </a>
  </div>

  <ul class="menu">
    <li><a href="9_ë§ˆë¼íƒ•ê³µì£¼ë“¤_index.html">í™ˆ</a></li>
    <li><a href="9_ë§ˆë¼íƒ•ê³µì£¼ë“¤_chat_list.html">ì±„íŒ…</a></li>
    <li><a href="9_ë§ˆë¼íƒ•ê³µì£¼ë“¤_checklist.html">ì²´í¬ë¦¬ìŠ¤íŠ¸</a></li>
    <li><a href="9_ë§ˆë¼íƒ•ê³µì£¼ë“¤_history.html">ë³´ê´€í•¨</a></li>
    <li><a href="9_ë§ˆë¼íƒ•ê³µì£¼ë“¤_setting.html">ì„¤ì •</a></li>
  </ul>

  <div class="nav-right-container">
    <!-- ê²€ìƒ‰ì°½ -->
    <div class="search-container">
      <input type="text" placeholder="ê²€ìƒ‰ (ì¹œêµ¬, ì±„íŒ…, ë³´ê´€í•¨ ë“±)">
      <button>ê²€ìƒ‰</button>
    </div>

    <!-- í”„ë¡œí•„ -->
    <div class="nav-right">
      <a href="9_ë§ˆë¼íƒ•ê³µì£¼ë“¤_login.html" class="profile">
        <img src="images/9_profile.jpg" alt="í”„ë¡œí•„ ì‚¬ì§„" class="profile-img" width="30" height="30">
        <span id="userId">ì‚¬ìš©ìId</span>
      </a>
    </div>
  </div>
</nav>

<!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
<div class="container">

  <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
  <div class="sidebar">
    <h3></h3>
    <div class="widget-box">
      <a href="9_ë§ˆë¼íƒ•ê³µì£¼ë“¤_checklist.html" class="widget-item">ğŸ“… ì¼ì •</a>
      <a href="9_ë§ˆë¼íƒ•ê³µì£¼ë“¤_history.html" class="widget-item">ğŸ“¸ ì¶”ì–µ</a>

      <input type="checkbox" id="memo-toggle" hidden>
      <label for="memo-toggle" class="widget-item">ğŸ“ ë©”ëª¨</label>
      <div class="memo-box">
        <textarea placeholder="ë©”ëª¨ë¥¼ ì‘ì„±í•˜ì„¸ìš”..."></textarea>
      </div>
    </div>
  </div>

  <!-- ì±„íŒ… ë³¸ë¬¸ -->
  <div class="chat-section">
    <div class="chat-messages"></div>

    <div class="chat-input">
      <label for="file-upload" class="attach-btn">ï¼‹</label>
      <input type="file" id="file-upload" hidden>
      <input type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
      <button class="send-btn">ì „ì†¡</button>
    </div>
  </div>

</div>

<!-- ë¡œê·¸ì¸ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸ -->
<script src="authCheck.js"></script>

<!-- Socket.IO í´ë¼ì´ì–¸íŠ¸ -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  try {
    console.log("âœ… DOMContentLoaded");

    // ===== 1. ë¡œê·¸ì¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸° =====
    const meRes = await fetch("/api/me", { credentials: "include" });
    if (!meRes.ok) throw new Error(`HTTP error! status: ${meRes.status}`);
    const meData = await meRes.json();
    if (!meData.success) throw new Error("ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ");

    const userId = meData.userId;
    document.getElementById("userId").textContent = meData.name;

    // ===== 2. URLì—ì„œ roomId ê°€ì ¸ì˜¤ê¸° =====
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get("roomId");
    if (!roomId) throw new Error("roomIdê°€ URLì— ì—†ìŒ");

    const messagesContainer = document.querySelector(".chat-messages");

    // ===== 3. ê¸°ì¡´ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° =====
    const res = await fetch(`/api/chatrooms/${encodeURIComponent(roomId)}/messages`, { credentials: "include" });
    const data = await res.json();
    if (!data.success) throw new Error("ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
    data.messages.forEach(addMessageToDOM);

    // ===== 4. Socket.IO ì—°ê²° =====
    const socket = io(); // ì„œë²„ì™€ ì—°ê²°
    socket.emit("joinRoom", roomId); // ë°© ì°¸ê°€

    // ===== 5. ë©”ì‹œì§€ ìˆ˜ì‹  =====
    socket.on("chatMessage", (msg) => {
      addMessageToDOM(msg);
    });

    // ===== 6. ë©”ì‹œì§€ ì „ì†¡ =====
    const sendBtn = document.querySelector(".send-btn");
    const input = document.querySelector(".chat-input input[type='text']");
    sendBtn.addEventListener("click", () => {
      const content = input.value.trim();
      if (!content) return;
      socket.emit("chatMessage", { roomId, sender: userId, content });
      input.value = "";
    });

    // ===== 7. ë©”ì‹œì§€ DOM ì¶”ê°€ í•¨ìˆ˜ =====
    function addMessageToDOM(msg) {
      const div = document.createElement("div");
      div.className = msg.sender === userId ? "message me" : "message friend";
      div.innerHTML = `
        <img src="${msg.sender === userId ? 'images/9_profile.jpg' : 'images/9_ì¹´í†¡ ê¸°ë³¸í”„ë¡œí•„ ì‚¬ì§„.jpg'}" class="chat-img">
        <div class="chat-content">
          <div class="chat-name">${msg.sender === userId ? "ë‚˜" : msg.sender}</div>
          <div class="bubble-row">
            <div class="bubble">${msg.content}</div>
            <div class="meta">
              <span class="time">${new Date(msg.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
            </div>
          </div>
        </div>
      `;
      messagesContainer.appendChild(div);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

  } catch (err) {
    console.error("âŒ ì±„íŒ… ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
    const messagesContainer = document.querySelector(".chat-messages");
    if (messagesContainer)
      messagesContainer.innerHTML = `<div>ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
  }
});
</script>

</body>
</html>
